<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tropical To-Do List App with Agenda</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (xlsx) library for Excel import/export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Use the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
            /* Tropical background image */
            background-image: url('https://images.pexels.com/photos/1430677/pexels-photo-1430677.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        /* Custom transition for list items */
        .task-item {
            transition: all 0.3s ease;
        }
        /* Style for completed tasks */
        .completed > .task-content-view > .task-text,
        .completed > .task-content-view > .task-due-date {
            text-decoration: line-through;
            color: #6b7280; /* gray-500 */
        }
        /* Simple animation for adding new tasks */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .new-task-animation {
            animation: fadeIn 0.5s ease;
        }
        /* Hide elements by default */
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="text-gray-900 dark:text-gray-100 flex items-start justify-center min-h-screen p-4 pt-8">

    <!-- Main container for both lists -->
    <div class="w-full max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Main Task List Container -->
        <div id="main-tasks-container" class="bg-white/70 dark:bg-gray-800/70 backdrop-blur-md rounded-2xl shadow-2xl p-6 md:p-8 h-fit">
            <!-- Header Section -->
            <div class="flex justify-between items-center mb-6 gap-4">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white">My Tasks</h1>
                <div class="flex items-center gap-2 flex-wrap justify-end">
                    <div class="text-blue-500 font-semibold">
                        <span id="task-count">0</span> tasks
                    </div>
                    <button id="import-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-transform transform hover:scale-105" aria-label="Import tasks">Import</button>
                    <button id="export-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-transform transform hover:scale-105" aria-label="Export tasks" title="Exports all tasks">Export</button>
                    <button id="agenda-button" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-transform transform hover:scale-105" aria-label="Create agenda" title="Select items then click here to create an agenda">Agenda</button>
                    <input type="file" id="import-file-input" class="hidden" accept=".xlsx, .xls">
                </div>
            </div>
            <!-- Form for adding new tasks -->
            <form id="add-task-form" class="space-y-4 md:space-y-0 md:flex md:items-center md:gap-3 mb-6">
                <input type="text" id="task-input" placeholder="Add a new task..." class="w-full md:flex-grow bg-gray-100/80 dark:bg-gray-700/80 border-2 border-transparent focus:border-blue-500 focus:ring-0 rounded-lg px-4 py-3" aria-label="New task input">
                <input type="date" id="task-due-date" class="w-full md:w-auto bg-gray-100/80 dark:bg-gray-700/80 border-2 border-transparent focus:border-pink-500 focus:ring-0 rounded-lg px-4 py-3" aria-label="Task due date">
                <button type="submit" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg shadow-md" aria-label="Add new task">Add</button>
            </form>
            <!-- List of tasks -->
            <div id="task-list" class="space-y-3"></div>
            <div id="no-tasks-message" class="text-center text-gray-500 dark:text-gray-300 py-8 hidden">
                <p class="font-medium">You have no tasks yet. Great job!</p>
            </div>
        </div>

        <!-- Agenda Container (Initially Hidden) -->
        <div id="agenda-container" class="hidden bg-white/70 dark:bg-gray-800/70 backdrop-blur-md rounded-2xl shadow-2xl p-6 md:p-8 h-fit">
             <!-- Header Section -->
            <div class="flex justify-between items-center mb-2 gap-4">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white">Agenda</h1>
                 <div class="flex items-center gap-2 flex-wrap justify-end">
                    <div class="text-orange-500 font-semibold">
                        <span id="agenda-task-count">0</span> tasks
                    </div>
                    <button id="agenda-export-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg shadow-md" aria-label="Export agenda">Export</button>
                </div>
            </div>
            <!-- Sort Controls -->
            <div class="flex items-center gap-2 mb-6">
                <button id="sort-priority-button" class="text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 font-semibold py-1 px-3 rounded-full">Sort by Priority</button>
                <button id="sort-date-button" class="text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 font-semibold py-1 px-3 rounded-full">Sort by Date</button>
            </div>
             <!-- List of agenda tasks -->
            <div id="agenda-list" class="space-y-3"></div>
             <div id="no-agenda-message" class="text-center text-gray-500 dark:text-gray-300 py-8">
                <p class="font-medium">No tasks selected for the agenda.</p>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDyzT-pLSS3OcP0VZIKmYOAKzUVsPY3nYo",
            authDomain: "to-do-app-18a80.firebaseapp.com",
            projectId: "to-do-app-18a80",
            storageBucket: "to-do-app-18a80.firebasestorage.app",
            messagingSenderId: "916170170270",
            appId: "1:916170170270:web:2c3dee9453d48a373a808f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let tasksCollection;
        let unsubscribe; // To detach the listener later if needed

        // --- Firebase Authentication ---
        signInAnonymously(auth)
            .then((userCredential) => {
                const user = userCredential.user;
                console.log("Signed in anonymously with UID:", user.uid);
                // Set up the Firestore collection reference for this user
                tasksCollection = collection(db, "users", user.uid, "tasks");
                // Start listening for real-time updates
                listenForTasks();
            })
            .catch((error) => {
                console.error("Anonymous sign-in failed:", error);
            });

        // --- DOM Element Selection ---
        const taskForm = document.getElementById('add-task-form');
        const taskInput = document.getElementById('task-input');
        const taskDueDateInput = document.getElementById('task-due-date');
        const taskList = document.getElementById('task-list');
        const taskCountElement = document.getElementById('task-count');
        const noTasksMessage = document.getElementById('no-tasks-message');
        const exportButton = document.getElementById('export-button');
        const importButton = document.getElementById('import-button');
        const importFileInput = document.getElementById('import-file-input');
        const agendaButton = document.getElementById('agenda-button');
        const agendaContainer = document.getElementById('agenda-container');
        const agendaList = document.getElementById('agenda-list');
        const agendaTaskCountElement = document.getElementById('agenda-task-count');
        const noAgendaMessage = document.getElementById('no-agenda-message');
        const agendaExportButton = document.getElementById('agenda-export-button');
        const sortPriorityButton = document.getElementById('sort-priority-button');
        const sortDateButton = document.getElementById('sort-date-button');

        // --- Helper Functions ---
        function getDueDateColorClasses(dueDateString) {
            if (!dueDateString) return '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const taskDate = new Date(dueDateString + 'T00:00:00');
            const diffTime = taskDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return 'text-red-600 dark:text-red-400';
            if (diffDays === 0) return 'text-red-600 dark:text-red-400';
            if (diffDays <= 7) return 'text-blue-600 dark:text-blue-400';
            return 'text-green-600 dark:text-green-400';
        }
        
        // --- Firestore Functions ---
        async function addTaskToFirestore(taskData) {
            try {
                await addDoc(tasksCollection, taskData);
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        }

        async function updateTaskInFirestore(taskId, updates) {
            const taskRef = doc(db, tasksCollection.path, taskId);
            try {
                await updateDoc(taskRef, updates);
            } catch (error) {
                console.error("Error updating document: ", error);
            }
        }

        async function deleteTaskFromFirestore(taskId) {
            const taskRef = doc(db, tasksCollection.path, taskId);
            try {
                await deleteDoc(taskRef);
            } catch (error) {
                console.error("Error deleting document: ", error);
            }
        }

        function listenForTasks() {
            if (unsubscribe) unsubscribe(); // Detach any old listener
            
            unsubscribe = onSnapshot(tasksCollection, (querySnapshot) => {
                taskList.innerHTML = ''; // Clear the list
                querySnapshot.forEach((doc) => {
                    const task = doc.data();
                    const taskElement = createTaskElement(doc.id, task.text, task.dueDate, task.completed, false);
                    taskList.appendChild(taskElement);
                });
                updateTaskCount();
            });
        }

        // --- Import/Export ---
        async function exportTasksToExcel() {
            if (!tasksCollection) return;
            const querySnapshot = await getDocs(tasksCollection);
            const tasksToExport = [];
            querySnapshot.forEach((doc) => {
                const task = doc.data();
                tasksToExport.push({
                    Task: task.text,
                    'Due Date': task.dueDate || 'N/A',
                    Status: task.completed ? 'Completed' : 'Pending'
                });
            });

            if (tasksToExport.length === 0) { console.log("No tasks to export."); return; }
            
            const worksheet = XLSX.utils.json_to_sheet(tasksToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Tasks');
            XLSX.writeFile(workbook, 'MyTasks.xlsx');
        }

        function importTasksFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonTasks = XLSX.utils.sheet_to_json(worksheet);

                jsonTasks.forEach(task => {
                    if (task.Task) {
                        let dueDate = '';
                        if (task['Due Date'] && task['Due Date'] !== 'N/A') {
                            try {
                                dueDate = new Date(task['Due Date']).toISOString().split('T')[0];
                            } catch (error) {
                                console.error("Could not parse date:", task['Due Date']);
                            }
                        }
                        const isCompleted = task.Status !== 'Pending';
                        
                        addTaskToFirestore({
                            text: task.Task,
                            dueDate: dueDate,
                            completed: isCompleted
                        });
                    }
                });
                importFileInput.value = ''; // Reset file input
            };
            reader.readAsArrayBuffer(file);
        }

        // --- Core Application Logic ---
        function updateTaskCount() {
            const count = taskList.querySelectorAll('.task-item').length;
            taskCountElement.textContent = count;
            noTasksMessage.classList.toggle('hidden', count > 0);
        }

        function updateAgendaCount() {
            const count = agendaList.querySelectorAll('.task-item').length;
            agendaTaskCountElement.textContent = count;
            noAgendaMessage.classList.toggle('hidden', count > 0);
        }

        function createTaskElement(id, taskText, dueDate, isCompleted = false, isAgenda = false) {
            const li = document.createElement('li');
            li.className = 'task-item flex items-center justify-between bg-white/50 dark:bg-gray-900/50 p-4 rounded-lg shadow-sm new-task-animation';
            li.dataset.taskId = id;
            li.dataset.dueDate = dueDate || '';

            if (isAgenda) {
                const priorityInput = document.createElement('input');
                priorityInput.type = 'number';
                priorityInput.min = '1';
                priorityInput.className = 'priority-input w-12 text-center bg-gray-200/80 dark:bg-gray-600/80 border-2 border-transparent focus:border-purple-500 ring-0 rounded-md px-1 py-1 mr-3 flex-shrink-0';
                priorityInput.placeholder = '#';
                li.appendChild(priorityInput);
            } else {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'agenda-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-4 flex-shrink-0';
                li.appendChild(checkbox);
            }

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'task-content-wrapper flex-grow';
            if (isCompleted) contentWrapper.classList.add('completed');

            const viewDiv = document.createElement('div');
            viewDiv.className = 'task-content-view cursor-pointer';
            
            const taskSpan = document.createElement('span');
            taskSpan.textContent = taskText;
            taskSpan.className = 'task-text text-gray-800 dark:text-gray-100';
            viewDiv.appendChild(taskSpan);

            if (dueDate) {
                const dateSpan = document.createElement('div');
                const dateObj = new Date(dueDate + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const colorClasses = getDueDateColorClasses(dueDate);
                dateSpan.textContent = `Due: ${formattedDate}`;
                dateSpan.className = `task-due-date text-sm font-medium mt-1 ${colorClasses}`;
                dateSpan.dataset.rawDate = dueDate;
                viewDiv.appendChild(dateSpan);
            }
            viewDiv.addEventListener('click', () => {
                const isNowCompleted = !contentWrapper.classList.contains('completed');
                updateTaskInFirestore(id, { completed: isNowCompleted });
            });
            contentWrapper.appendChild(viewDiv);

            const editDiv = document.createElement('div');
            editDiv.className = 'task-content-edit hidden space-y-2';
            const editInput = document.createElement('input');
            editInput.type = 'text';
            editInput.value = taskText;
            editInput.className = 'w-full bg-gray-200/80 dark:bg-gray-600/80 border-2 border-blue-500 ring-0 rounded-md px-2 py-1';
            const editDateInput = document.createElement('input');
            editDateInput.type = 'date';
            editDateInput.value = dueDate;
            editDateInput.className = 'w-full bg-gray-200/80 dark:bg-gray-600/80 border-2 border-pink-500 ring-0 rounded-md px-2 py-1';
            editDiv.appendChild(editInput);
            editDiv.appendChild(editDateInput);
            contentWrapper.appendChild(editDiv);
            li.appendChild(contentWrapper);

            const buttonWrapper = document.createElement('div');
            buttonWrapper.className = 'flex items-center ml-4 flex-shrink-0';

            const editButton = document.createElement('button');
            editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>`;
            editButton.className = 'edit-btn text-gray-500 dark:text-gray-400 hover:text-blue-500';
            editButton.addEventListener('click', (e) => {
                e.stopPropagation();
                const isEditing = viewDiv.classList.contains('hidden');
                
                if (isEditing) { // --- SAVE ---
                    const newText = editInput.value.trim();
                    const newDueDate = editDateInput.value;
                    updateTaskInFirestore(id, { text: newText, dueDate: newDueDate });
                }
                
                viewDiv.classList.toggle('hidden');
                editDiv.classList.toggle('hidden');
            });

            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
            deleteButton.className = 'text-gray-500 dark:text-gray-400 hover:text-red-500 ml-2';
            deleteButton.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteTaskFromFirestore(id);
            });

            buttonWrapper.appendChild(editButton);
            buttonWrapper.appendChild(deleteButton);
            li.appendChild(buttonWrapper);

            return li;
        }

        function generateAgenda() {
            agendaList.innerHTML = '';
            const selectedTasks = taskList.querySelectorAll('.agenda-checkbox:checked');
            if (selectedTasks.length > 0) {
                agendaContainer.classList.remove('hidden');
                selectedTasks.forEach(checkbox => {
                    const mainTaskElement = checkbox.closest('.task-item');
                    const { taskId, text, dueDate, completed } = {
                        taskId: mainTaskElement.dataset.taskId,
                        text: mainTaskElement.querySelector('.task-text').textContent,
                        dueDate: mainTaskElement.querySelector('.task-due-date')?.dataset.rawDate || '',
                        completed: mainTaskElement.querySelector('.task-content-wrapper').classList.contains('completed')
                    };
                    const agendaTaskElement = createTaskElement(taskId, text, dueDate, completed, true);
                    agendaList.appendChild(agendaTaskElement);
                });
            } else {
                agendaContainer.classList.add('hidden');
            }
            updateAgendaCount();
        }

        function sortAgenda(sortBy) {
            const items = Array.from(agendaList.children);
            items.sort((a, b) => {
                if (sortBy === 'priority') {
                    const priorityA = a.querySelector('.priority-input').value || 9999;
                    const priorityB = b.querySelector('.priority-input').value || 9999;
                    return priorityA - priorityB;
                }
                if (sortBy === 'date') {
                    const dateA = a.dataset.dueDate ? new Date(a.dataset.dueDate) : new Date('9999-12-31');
                    const dateB = b.dataset.dueDate ? new Date(b.dataset.dueDate) : new Date('9999-12-31');
                    return dateA - dateB;
                }
                return 0;
            });
            items.forEach(item => agendaList.appendChild(item));
        }

        // --- Event Listeners ---
        taskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const taskText = taskInput.value.trim();
            const dueDate = taskDueDateInput.value;
            if (taskText !== '') {
                addTaskToFirestore({
                    text: taskText,
                    dueDate: dueDate,
                    completed: false
                });
                taskInput.value = '';
                taskDueDateInput.value = '';
            }
        });

        exportButton.addEventListener('click', exportTasksToExcel);
        importButton.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', importTasksFromExcel);
        
        agendaButton.addEventListener('click', generateAgenda);
        agendaExportButton.addEventListener('click', () => {
             // This can be adapted similarly to the main export button if needed
        });
        sortPriorityButton.addEventListener('click', () => sortAgenda('priority'));
        sortDateButton.addEventListener('click', () => sortAgenda('date'));

    </script>
</body>
</html>

